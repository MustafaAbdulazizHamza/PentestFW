import mysql.connector as ms
import os
import hashlib
import subprocess as sp
import getpass
from colorama import Fore

loc = os.path.dirname(os.path.abspath(__file__))
if not os.path.exists(f"{loc}/Data"): os.mkdir(f"{loc}/Data")
FW_username = input(Fore.CYAN+'Enter your username: '+Fore.RESET)
FW_passwd = getpass.getpass(Fore.CYAN+f'Enter yur password: '+Fore.RESET)
FW_passwd = hashlib.sha256(FW_passwd.encode()).hexdigest()
print('\n')
print('Login information for the MySQL server: ')
username = input(Fore.CYAN+'The Username: '+Fore.RESET)
passwd = getpass.getpass(Fore.CYAN+f'The Password for {username}: '+Fore.RESET)
with open(f'{loc}/Data/login.txt', 'w') as login:
    login.write(f"{username}\n{passwd}")
db = ms.connect(host='localhost', user=username, password=passwd)
with open(f'{os.path.dirname(os.path.abspath(__file__))}/SQL/PentestFW_DB.sql') as sql:
    commands = sql.read()
    for cmd in commands.split(';'):
        cursor = db.cursor()
        if cmd:
            cursor.execute(f'{cmd};', multi=True)
            db.commit()
            cursor.close()

with db.cursor() as cur:
    cur.execute("USE PentestFW;")
    cur.execute(f"INSERT INTO Users(username, pass_word) VALUES('{FW_username}', '{FW_passwd}');")
    db.commit()
modules = [module.split('.')[0] for module in os.listdir(f"{loc}/Modules") if os.path.isfile(f"{loc}/Modules/{module}")]
for module in modules:
    cursor = db.cursor()
    cat = sp.run(f'python3 {loc}/Modules/{module}.py --Category', shell=True, stdout=sp.PIPE, text=True)
    desc = sp.run(f'python3 {loc}/Modules/{module}.py --Description', shell=True, stdout=sp.PIPE, text=True)
    command = f"INSERT INTO Modules(module, category_ID, module_description) VALUES('{module}',{cat.stdout.strip()}, '{desc.stdout.strip()}');"
    cursor.execute("USE PentestFW;")
    cursor.execute(command)
    db.commit()
    cursor.close()
print(Fore.GREEN+'PentestFW was successfully installed on your machine'+Fore.RESET)
